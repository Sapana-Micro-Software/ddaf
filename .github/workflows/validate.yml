name: Validate Site Build

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install npm dependencies
        run: |
          echo "ğŸ“¦ Installing Node.js dependencies..."
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Build TypeScript
        run: |
          echo "ğŸ”¨ Building TypeScript..."
          npm run build
          echo "âœ… TypeScript build completed"

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Install dependencies
        run: bundle install

      - name: Validate Jekyll build
        run: |
          echo "ğŸ” Validating Jekyll configuration and build..."
          bundle exec jekyll build --destination ./_site_test
          
          if [ ! -f "_site_test/index.html" ]; then
            echo "âŒ Validation failed: index.html not found"
            exit 1
          fi
          
          echo "âœ… Jekyll build validation passed!"
          echo "ğŸ“Š Build output size: $(du -sh _site_test | cut -f1)"

      - name: Check for broken links (basic)
        run: |
          echo "ğŸ”— Checking for common issues..."
          if grep -r "{{ site." _site_test/ 2>/dev/null; then
            echo "âš ï¸  Warning: Found unresolved Jekyll variables"
            grep -r "{{ site." _site_test/ | head -5
          else
            echo "âœ… No unresolved Jekyll variables found"
          fi
